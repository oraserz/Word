name: Build Signed RPK on Tag Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-rpk:
    runs-on: ubuntu-latest
    env:
      TEMP_SIGN_DIR: ${{ github.workspace }}/.temp_sign

    steps:
      # 0. å¤„ç†ç‰ˆæœ¬å·ï¼ˆç§»é™¤'v'å‰ç¼€ï¼‰
      - name: Process version number
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=${VERSION}" >> $GITHUB_ENV
          echo "BUILD_OUTPUT=com.isotope.2048.band.${VERSION}.rpk" >> $GITHUB_ENV

      # 1. ä»£ç æ£€å‡ºï¼ˆä¿ç•™å®Œæ•´gitå†å²ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. è®¾ç½®Node.jsç¯å¢ƒ
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 20.x
          cache: 'npm'

      # 3. å®‰è£…ä¾èµ–å¹¶éªŒè¯aiotå·¥å…·é“¾
      - name: Install dependencies
        run: |
          npm install
          if [ ! -f "node_modules/.bin/aiot" ]; then
            echo "::error::aiot-toolkit not found in node_modules/.bin/"
            exit 1
          fi

      # 4. å®‰å…¨å†™å…¥å¯†é’¥æ–‡ä»¶
      - name: Setup Signing Files
        run: |
          mkdir -p $TEMP_SIGN_DIR
          if [ -z "${{ secrets.PRIVATE_PEM }}" ] || [ -z "${{ secrets.CERTIFICATE_PEM }}" ]; then
            echo "::error::Missing PRIVATE_PEM or CERTIFICATE_PEM in secrets"
            exit 1
          fi
          echo "${{ secrets.PRIVATE_PEM }}" > $TEMP_SIGN_DIR/private.pem
          echo "${{ secrets.CERTIFICATE_PEM }}" > $TEMP_SIGN_DIR/certificate.pem
          if ! grep -q "BEGIN PRIVATE KEY" $TEMP_SIGN_DIR/private.pem || \
             ! grep -q "BEGIN CERTIFICATE" $TEMP_SIGN_DIR/certificate.pem; then
            echo "::error::Invalid PEM format"
            exit 1
          fi
          chmod 700 $TEMP_SIGN_DIR
          chmod 600 $TEMP_SIGN_DIR/*.pem

      # 5. å¯†é’¥å¯¹éªŒè¯ï¼ˆéé˜»å¡å¼ï¼‰
      - name: Validate Key Pair
        continue-on-error: true
        run: |
          openssl rsa -in $TEMP_SIGN_DIR/private.pem -noout -check
          if [ "$(openssl rsa -in $TEMP_SIGN_DIR/private.pem -noout -modulus | openssl sha256)" != \
               "$(openssl x509 -in $TEMP_SIGN_DIR/certificate.pem -noout -modulus | openssl sha256)" ]; then
            echo "::warning::Key pair mismatch (proceeding with unsigned build)"
          fi

      # 6. æ„å»ºRPKï¼ˆæ ¹æ®å¯†é’¥çŠ¶æ€å†³å®šæ˜¯å¦ç­¾åï¼‰
      - name: Build RPK
        run: |
          # åˆ›å»ºä¸´æ—¶é…ç½®æ–‡ä»¶
          cat > aiot.config.js <<EOF
          module.exports = {
            sign: {
              cert: '$TEMP_SIGN_DIR/certificate.pem',
              privateKey: '$TEMP_SIGN_DIR/private.pem'
            }
          }
          EOF
          
          # æ‰§è¡Œæ„å»º
          if grep -q "BEGIN PRIVATE KEY" $TEMP_SIGN_DIR/private.pem; then
            echo "::info::Building signed RPK package"
            ./node_modules/.bin/aiot build
          else
            echo "::warning::Building unsigned RPK due to invalid signing key"
            ./node_modules/.bin/aiot build
          fi
          
          # æ£€æŸ¥æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨
          if ! ls dist/*.rpk 1> /dev/null 2>&1; then
            echo "::error::No RPK file generated in dist directory"
            exit 1
          fi
          
          # é‡å‘½åè¾“å‡ºæ–‡ä»¶
          mv dist/*.rpk ${{ env.BUILD_OUTPUT }}

      # 7. ç²¾ç¡®åŒ¹é…çš„æ›´æ–°æ—¥å¿—ç”Ÿæˆ
      - name: Generate precise changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªreleaseçš„tagï¼ˆæ›´å¯é çš„è·å–æ–¹å¼ï¼‰
          PREV_RELEASE=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=2" | \
            jq -r '.[].tag_name' | \
            grep -v "${{ github.ref_name }}" | \
            head -n 1 || echo "")
          
          # è®¾ç½®æ—¥å¿—èŒƒå›´
          if [ -z "$PREV_RELEASE" ]; then
            echo "æ²¡æœ‰æ‰¾åˆ°ä¹‹å‰çš„releaseï¼Œä»åˆå§‹æäº¤å¼€å§‹ç”Ÿæˆæ—¥å¿—"
            CHANGELOG_RANGE=""
          else
            CHANGELOG_RANGE="$PREV_RELEASE..${{ github.ref_name }}"
          fi
          
          # ç”Ÿæˆæ ‡é¢˜
          echo "CHANGELOG_TITLE=## ğŸ“ æ›´æ–°æ—¥å¿— ${PREV_RELEASE:-åˆå§‹ç‰ˆæœ¬} â†’ ${{ github.ref_name }}" >> $GITHUB_ENV
          
          # ç”Ÿæˆå†…å®¹ï¼ˆä¿®å¤heredocè¯­æ³•é—®é¢˜ï¼‰
          CHANGELOG_CONTENT=$(git log --pretty=format:"- **%s**%n  è´¡çŒ®è€…ï¼š%an <%ae>%n  æäº¤æ—¶é—´ï¼š%ad%n  %b" \
            --date=format:"%Y-%m-%d %H:%M:%S" \
            $CHANGELOG_RANGE | \
            sed '/^  $/d' | \
            sed 's/^  $$BUG$$/[BUG]/')
          
          # ä½¿ç”¨ç¯å¢ƒå˜é‡å­˜å‚¨å†…å®¹
          echo "CHANGELOG_BODY<<EOF" >> $GITHUB_ENV
          echo "$CHANGELOG_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # 8. è·å–æ„å»ºå…ƒæ•°æ®
      - name: Gather metadata
        id: meta
        run: |
          # æ„å»ºæ—¶é—´ï¼ˆUTC+8ï¼‰
          echo "time=$(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_OUTPUT
          
          # ç­¾åçŠ¶æ€
          if grep -q "BEGIN PRIVATE KEY" $TEMP_SIGN_DIR/private.pem; then
            echo "sign_status=å·²ç­¾å (Signed)" >> $GITHUB_OUTPUT
          else
            echo "sign_status=æœªç­¾å (Unsigned)" >> $GITHUB_OUTPUT
          fi
          
          # è·å–commitçŸ­ID
          echo "short_sha=$(git rev-parse --short ${{ github.sha }})" >> $GITHUB_OUTPUT

      # 9. åˆ›å»ºæ ¼å¼åŒ–çš„GitHub Release
      - name: Create Formatted Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: ğŸ‰ Release ${{ github.ref_name }}
          body: |
            ${{ env.CHANGELOG_TITLE }}
            ${{ env.CHANGELOG_BODY }}

            ## ğŸ› ï¸ æ„å»ºä¿¡æ¯
            - ğŸ•’ æ„å»ºæ—¶é—´: ${{ steps.meta.outputs.time }} (UTC+8)
            - ğŸ·ï¸ æ ‡ç­¾: ${{ github.ref_name }}
            - ğŸ”— æäº¤: [${{ steps.meta.outputs.short_sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
            - ğŸ” ç­¾åçŠ¶æ€: ${{ steps.meta.outputs.sign_status }}
            - ğŸ“¦ æ„å»ºäº§ç‰©: ${{ env.BUILD_OUTPUT }}
          files: ${{ env.BUILD_OUTPUT }}
          draft: false
          prerelease: false